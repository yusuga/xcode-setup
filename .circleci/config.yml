version: 2.1
executors:
  macos_executor:
    macos:
      xcode: "13.0.0"
    environment:
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
      DERIVED_DATA_PATH: DerivedData
      OUTPUT_PATH: output
    shell: /bin/bash --login -eo pipefail
  machine_executor:
    machine:
      image: ubuntu-2004:202010-01

commands:
  resolve_gem:
    steps:
      - checkout
      - restore_cache:
          name: Restoring gem
          key: gem-{{ .Environment.CACHE_VERSION }}-{{ checksum "Gemfile.lock" }}
      - run:
          command: make check-gem || make gem
      - save_cache:
          name: Saving gem
          key: gem-{{ .Environment.CACHE_VERSION }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - persist_to_workspace:
          root: .
          paths:
            - vendor/bundle
  resolve_git_submodule:
    steps:
      - checkout
      - run: 
          command: make git-submodule
          working_directory: App
      - persist_to_workspace:
          root: .
          paths:
            - App/Mint
  make_app_dependencies:
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          name: Restoring mint
          key: 1-mint-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Mint/CHANGELOG.md" }}
      - restore_cache:
          name: Restoring mintfile
          key: 1-mintfile-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Mintfile" }}
      - run:
          command: make mint
          working_directory: App
      - save_cache:
          name: Saving mint
          key: 1-mint-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Mint/CHANGELOG.md" }}
          paths:
            - App/Mint/.build/apple/Products/Release/mint
      - save_cache:
          name: Saving mintfile
          key: 1-mintfile-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Mintfile" }}
          paths:
            - App/.mint
      - restore_cache:
          name: Restoring Carthage
          key: carthage-build-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Cartfile.resolved" }}
      - run:
          command: make carthage USE_CACHE=true
          working_directory: App
          no_output_timeout: 1h
      - save_cache:
          key: carthage-build-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Cartfile.resolved" }}
          paths:
            - App/Carthage/Build
      - run:
          command: make asset-files
          working_directory: App
      - run:
          command: make xcodeproj
          working_directory: App
      - persist_to_workspace:
          root: .
          paths:
            - App/Mint
            - App/.mint
            - App/Carthage/Build
            - App/App/Assets/Assets.swift
            - App/App.xcodeproj
  make_cocoapods:
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          name: Restoring CocoaPods
          key: pod-build-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Podfile.lock" }}
      - run:
          command: make cocoapods
          working_directory: App
      - run:
          # Required to resolve `Permission denied` for persist_to_workspace.
          command: |
            sudo chown -R circleci Pods
            sudo chown -R circleci App.xcodeproj
            sudo chown -R circleci App.xcworkspace
          working_directory: App          
      - save_cache:
          key: pod-build-{{ .Environment.CACHE_VERSION }}-{{ checksum "App/Podfile.lock" }}
          paths:
            - App/Pods
      - persist_to_workspace:
          root: .
          paths:
            - App/Pods
            - App/App.xcodeproj
            - App/App.xcworkspace
  build_app:
    parameters:
      configuration:
        type: enum
        enum: ["release"]
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: add github ip addresses to known hosts
          command: for ip in $(dig @8.8.8.8 github.com +short); do ssh-keyscan github.com,$ip; ssh-keyscan $ip; done 2>/dev/null >> ~/.ssh/known_hosts
      - run:
          command: bundle exec fastlane build configuration:<< parameters.configuration >>
          no_output_timeout: 1h
  build_app_for_simulator:
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: add github ip addresses to known hosts
          command: for ip in $(dig @8.8.8.8 github.com +short); do ssh-keyscan github.com,$ip; ssh-keyscan $ip; done 2>/dev/null >> ~/.ssh/known_hosts
      - run: 
          command: |
            mkdir ${DERIVED_DATA_PATH}
            mkdir ${OUTPUT_PATH}
      - run:
          command: bundle exec fastlane build_for_simulator derived_data_path:${DERIVED_DATA_PATH}
          no_output_timeout: 1h
      - run:
          name: Copy app
          command: |
            mv "$(find ${DERIVED_DATA_PATH} -name \*.app -print -quit)" ${OUTPUT_PATH}
            ls ${OUTPUT_PATH}
      - store_artifacts:
          # Note: Environment variables are not available in store_artifacts
          path: output
      - persist_to_workspace:
          root: .
          paths:
            - output
  magic-pod-e2e-test:
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          ls ${OUTPUT_PATH}
      - restore_cache:
          name: Restoring magic-pod-api-client
          key: magic-pod-api-client-linux-{{ .Environment.CACHE_VERSION }}-{{ .Environment.MAGIC_POD_API_CLIENT_VERSION }}
      - run:
          name: GET magic-pod-api-client
          command: |
            if [ ! -f linux64_magic-pod-api-client.zip ]; then
              curl -L -O https://github.com/Magic-Pod/magic-pod-api-client/releases/download/${MAGIC_POD_API_CLIENT_VERSION}/linux64_magic-pod-api-client.zip
            fi
            unzip linux64_magic-pod-api-client.zip
      - save_cache:
          name: Saving magic-pod-api-client
          key: magic-pod-api-client-linux-{{ .Environment.CACHE_VERSION }}-{{ .Environment.MAGIC_POD_API_CLIENT_VERSION }}
          paths:
            - linux64_magic-pod-api-client.zip
      - run:
          # https://help.trident-qa.com/magic-pod-circleci/
          name: MagicPod E2E Test
          command: |
            # 前回アップロードしたアプリを削除（`batch-run -n` だとアップロードしたアプリが溜まり続けるためこのタイミングで削除）
            ./magic-pod-api-client delete-app -a 1 || true
            
            # app/ipa/apkファイルをMagic Podにアップロードして、FILE_NOを取得
            FILE_NO=$(./magic-pod-api-client upload-app -a "$(find output -name \*.app -print -quit)")
            BATCH_TEST_NUMBER=1
            
            # 先ほどアップロードしたアプリと、設定番号の設定を使ってテスト一括実行（`-n` で一括テスト結果を待たない)
            ./magic-pod-api-client batch-run -s "{\"app_file_number\":\"${FILE_NO}\"}" -S ${BATCH_TEST_NUMBER} -n
            
            # テストが成功した場合はアップロードしたアプリは削除
#             if [ $? = 0 ]; then
#               ./magic-pod-api-client delete-app -a ${FILE_NO}
#             fi

jobs:
  resolve_deploy_tools:
    executor: macos_executor
    steps:
      - resolve_gem
  resolve_git_submodule:
    executor: machine_executor
    steps:
      - resolve_git_submodule
  resolve_app_dependencies_on_macos:
    executor: macos_executor
    steps:
      - make_app_dependencies
  resolve_app_dependencies_on_docker:
    executor: machine_executor
    steps:
      - make_cocoapods
  build_app:
    executor: macos_executor
    steps:
      - build_app:
          configuration: release
  build_app_for_simulator:
    executor: macos_executor
    steps:
      - build_app_for_simulator
  magic-pod-e2e-test:
    executor: machine_executor
    steps:
      - magic-pod-e2e-test

workflows:
  version: 2
  test_and_release:
    jobs:
      - resolve_deploy_tools:
          filters:
            branches:
              only:
                - master
      - resolve_git_submodule:
          filters:
            branches:
              only:
                - master
      - resolve_app_dependencies_on_macos:
          filters:
            branches:
              only:
                - master
          requires:
            - resolve_git_submodule
      - resolve_app_dependencies_on_docker:
          filters:
            branches:
              only:
                - master
          requires:
            - resolve_app_dependencies_on_macos
#       - build_app:
#           filters:
#             branches:
#               only:
#                 - master
#           requires:
#             - resolve_deploy_tools
#             - resolve_app_dependencies_on_docker
      - build_app_for_simulator:
          filters:
            branches:
              only:
                - master
          requires:
            - resolve_deploy_tools
            - resolve_app_dependencies_on_docker
      - magic-pod-e2e-test:
          filters:
            branches:
              only:
                - master
          requires:
            - build_app_for_simulator